import os
import asyncio
from datetime import datetime, timezone
from telethon import TelegramClient
from feedgen.feed import FeedGenerator

print("=== RSS GENERATOR STARTED ===")

api_id = int(os.environ["API_ID"])
api_hash = os.environ["API_HASH"]

client = TelegramClient("session_user", api_id, api_hash)
CHANNEL = "news_cryptod"          # ← если хочешь другой канал — поменяй здесь

async def main():
    print("Connecting to Telegram...")
    await client.start()
    me = await client.get_me()
    print(f"Successfully logged in as: {me.first_name} (@{me.username or 'no username'})")

    fg = FeedGenerator()
    fg.title("Crypto News Mirror")
    fg.description("Автоматическая RSS-лента из @news_cryptod")
    fg.link(href="https://maksyI686.github.io/tgone/rss.xml", rel="self")
    fg.language("ru")
    fg.lastBuildDate(datetime.now(timezone.utc))

    count = 0
    print(f"Fetching last 50 messages from @{CHANNEL}...")
    async for message in client.iter_messages(CHANNEL, limit=50):
        if not message.message:
            continue

        count += 1
        entry = fg.add_entry(order="prepend")  # новые сверху
        entry.id(f"https://t.me/{CHANNEL}/{message.id}")
        title = message.message.split("\n", 1)[0][:100]
        if len(message.message.split("\n", 1)[0]) > 100:
            title += "..."
        entry.title(title)
        entry.link(href=f"https://t.me/{CHANNEL}/{message.id}")
        entry.description(message.message.replace("&", "&amp;").replace("<", "&lt;").replace(">", "&gt;"))
        entry.pubDate(message.date.replace(tzinfo=timezone.utc))  # ФИКС ТУТ

    fg.rss_file("rss.xml", pretty=True)
    print(f"RSS file created! {count} entries, size: {os.path.getsize('rss.xml')} bytes")

    await client.disconnect()
    print("=== RSS GENERATOR FINISHED ===")

if __name__ == "__main__":
    asyncio.run(main())
